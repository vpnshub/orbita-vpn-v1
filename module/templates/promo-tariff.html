{% extends "base.html" %}

{% block title %}Промо-тарифы - Админ Панель{% endblock %}

{% block page_title %}<i class="mdi mdi-gift mr-2"></i>Управление промо-тарифами{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item active">Промо-тарифы</li>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h4 class="mt-0 header-title">Список промо-тарифов</h4>
                        <p class="text-muted">Специальные тарифы для акций и подарков</p>
                    </div>
                    <div>
                        <button type="button" class="btn btn-primary btn-square btn-outline-dashed waves-effect waves-light" id="addPromoBtn">
                            <i class="mdi mdi-plus mr-2"></i>Добавить промо-тариф
                        </button>
                    </div>
                </div>

                <div class="alert alert-dark border-0">
                    <i class="mdi mdi-information-outline mr-2"></i>
                    Промо-тарифы недоступны для покупки пользователями и выдаются только вручную администратором. Отправка промо-тарифа осуществляется по Telegram ID. Пользователь должен быть зарегистрирован в боте, иначе бот не сможет отправить ему сообщение из-за ограничений Telegram.
                </div>
                
                <div class="table-responsive">
                    <table class="table table-bordered mb-0">
                        <thead>
                            <tr>
                                <th>Наименование</th>
                                <th>Описание</th>
                                <th class="text-center">Дней доступа</th>
                                <th class="text-center">Сервер</th>
                                <th class="text-center">Статус</th>
                                <th class="text-center">Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if promos %}
                                {% for promo in promos %}
                                <tr>
                                    <td>{{ promo.name }}</td>
                                    <td>{{ promo.description }}</td>
                                    <td class="text-center">{{ promo.left_day }}</td>
                                    <td class="text-center">{{ promo.server_name }}</td>
                                    <td class="text-center">
                                        {% if promo.is_enable == 1 %}
                                            <span class="badge badge-success">Активен</span>
                                        {% else %}
                                            <span class="badge badge-danger">Не активен</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        <button type="button" class="btn btn-info btn-square btn-outline-dashed waves-effect waves-light send-promo" 
                                                data-id="{{ promo.id }}"
                                                data-name="{{ promo.name }}">
                                                <i class="mdi mdi-send mr-2"></i>Отправить
                                        </button>
                                        <button type="button" class="btn btn-danger btn-square btn-outline-dashed waves-effect waves-light delete-promo" 
                                                data-id="{{ promo.id }}">
                                                <i class="mdi mdi-delete mr-2"></i>Удалить
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="6" class="text-center">
                                        {% if error_message %}
                                            <div class="alert alert-danger">{{ error_message }}</div>
                                        {% else %}
                                            Нет доступных промо-тарифов или соединение с API не установлено.
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="addPromoModal" tabindex="-1" role="dialog" aria-labelledby="addPromoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addPromoModalLabel">Создание промо-тарифа</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="addPromoForm">
                    <div class="form-group">
                        <label for="add_promo_name">Наименование</label>
                        <input type="text" class="form-control" id="add_promo_name" required>
                    </div>
                    <div class="form-group">
                        <label for="add_promo_description">Описание</label>
                        <textarea class="form-control" id="add_promo_description" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="add_promo_left_day">Количество дней</label>
                        <input type="number" class="form-control" id="add_promo_left_day" required>
                    </div>
                    <div class="form-group">
                        <label for="add_promo_server_id">Сервер</label>
                        <select class="form-control" id="add_promo_server_id" required>
                            <option value="">Выберите сервер</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-square btn-outline-dashed waves-effect waves-light" data-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary btn-square btn-outline-dashed waves-effect waves-light" id="savePromoBtn">
                    <i class="mdi mdi-content-save mr-2"></i>Сохранить
                </button>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="sendPromoModal" tabindex="-1" role="dialog" aria-labelledby="sendPromoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="sendPromoModalLabel">Отправка промо-тарифа</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="sendPromoForm">
                    <input type="hidden" id="send_promo_id">
                    <div class="form-group">
                        <label for="send_promo_name">Тариф</label>
                        <input type="text" class="form-control" id="send_promo_name" readonly>
                    </div>
                    <div class="form-group">
                        <label for="send_telegram_id">Telegram ID пользователя</label>
                        <input type="number" class="form-control" id="send_telegram_id" required>
                        <small class="form-text text-muted">Введите числовой ID пользователя Telegram</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-square btn-outline-dashed waves-effect waves-light" data-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-info btn-square btn-outline-dashed waves-effect waves-light" id="confirmSendPromoBtn">
                    <i class="mdi mdi-send mr-2"></i>Отправить
                </button>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="deletePromoModal" tabindex="-1" role="dialog" aria-labelledby="deletePromoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deletePromoModalLabel">Подтверждение удаления</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Вы уверены, что хотите удалить этот промо-тариф?</p>
                <input type="hidden" id="delete_promo_id">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-square btn-outline-dashed waves-effect waves-light" data-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-danger btn-square btn-outline-dashed waves-effect waves-light" id="confirmDeletePromoBtn">
                    <i class="mdi mdi-delete mr-2"></i>Удалить
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        function loadServers(selectElement, selectedId) {
            $.ajax({
                url: "{{ url_for('get_servers') }}",
                type: 'GET',
                success: function(response) {
                    if (response.success) {
                        $(selectElement).find('option').not(':first').remove();
                        
                        $.each(response.servers, function(i, server) {
                            var option = $('<option>', {
                                value: server.id,
                                text: server.name
                            });
                            
                            if (selectedId && server.id == selectedId) {
                                option.attr('selected', 'selected');
                            }
                            
                            $(selectElement).append(option);
                        });
                    } else {
                        alert('Ошибка при загрузке серверов: ' + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    alert('Произошла ошибка при загрузке списка серверов.');
                    console.error(error);
                }
            });
        }
        
        $('#addPromoBtn').on('click', function() {
            $('#addPromoForm')[0].reset();
            
            loadServers('#add_promo_server_id');
            
            $('#addPromoModal').modal('show');
        });
        
        $('#savePromoBtn').on('click', function() {
            if (!$('#add_promo_name').val() || !$('#add_promo_left_day').val() || !$('#add_promo_server_id').val()) {
                alert('Пожалуйста, заполните все обязательные поля');
                return;
            }
            
            var promoData = {
                name: $('#add_promo_name').val(),
                description: $('#add_promo_description').val(),
                left_day: parseInt($('#add_promo_left_day').val()),
                server_id: parseInt($('#add_promo_server_id').val())
            };
            
            $.ajax({
                url: "{{ url_for('create_promo') }}",
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(promoData),
                success: function(response) {
                    if (response.success) {
                        $('#addPromoModal').modal('hide');
                        
                        location.reload();
                    } else {
                        alert('Ошибка: ' + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    alert('Произошла ошибка при создании промо-тарифа. Пожалуйста, попробуйте снова.');
                    console.error(error);
                }
            });
        });
        
        $('.send-promo').on('click', function() {
            var id = $(this).data('id');
            var name = $(this).data('name');
            
            $('#send_promo_id').val(id);
            $('#send_promo_name').val(name);
            
            $('#send_telegram_id').val('');
            
            $('#sendPromoModal').modal('show');
        });
        
        $('#confirmSendPromoBtn').on('click', function() {
            if (!$('#send_telegram_id').val()) {
                alert('Пожалуйста, введите Telegram ID пользователя');
                return;
            }
            
            var sendData = {
                promo_id: parseInt($('#send_promo_id').val()),
                telegram_id: parseInt($('#send_telegram_id').val())
            };
            
            $.ajax({
                url: "{{ url_for('send_promo') }}",
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(sendData),
                success: function(response) {
                    if (response.success) {
                        $('#sendPromoModal').modal('hide');
                        
                        alert('Промо-тариф успешно отправлен пользователю');
                    } else {
                        alert('Ошибка: ' + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    alert('Произошла ошибка при отправке промо-тарифа. Пожалуйста, попробуйте снова.');
                    console.error(error);
                }
            });
        });
        
        $('.delete-promo').on('click', function() {
            var id = $(this).data('id');
            $('#delete_promo_id').val(id);
            $('#deletePromoModal').modal('show');
        });
        
        $('#confirmDeletePromoBtn').on('click', function() {
            var id = $('#delete_promo_id').val();
            
            $.ajax({
                url: "{{ url_for('delete_promo') }}",
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ id: id }),
                success: function(response) {
                    if (response.success) {
                        $('#deletePromoModal').modal('hide');
                        
                        location.reload();
                    } else {
                        alert('Ошибка: ' + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    alert('Произошла ошибка при удалении. Пожалуйста, попробуйте снова.');
                    console.error(error);
                }
            });
        });
    });
</script>
{% endblock %} 