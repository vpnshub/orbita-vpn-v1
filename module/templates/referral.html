{% extends "base.html" %}

{% block title %}Реферальная программа - Админ Панель{% endblock %}

{% block page_title %}<i class="mdi mdi-account-group mr-2"></i>Управление реферальной программой{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item active">Реферальная программа</li>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h4 class="mt-0 header-title">Реферальные программы</h4>
                        <p class="text-muted">Настройка условий получения вознаграждения при приглашении новых пользователей</p>
                    </div>
                    <div>
                        <button type="button" class="btn btn-primary btn-square btn-outline-dashed waves-effect waves-light" id="addReferralBtn">
                            <i class="mdi mdi-plus mr-2"></i>Добавить реф.программу
                        </button>
                    </div>
                </div>

                <div class="alert alert-dark border-0">
                    <i class="mdi mdi-information-outline mr-2"></i>
                    Настройка реферальных условий для мотивации пользователей к приглашению новых клиентов. Вознаграждение начисляется после выполнения условий по количеству приглашенных.
                </div>
                
                <div class="table-responsive">
                    <table class="table table-bordered mb-0">
                        <thead>
                            <tr>
                                <th>Наименование</th>
                                <th>Описание</th>
                                <th class="text-center">Количество приглашенных</th>
                                <th class="text-center">Вознаграждение</th>
                                <th>Дата запуска</th>
                                <th class="text-center">Статус</th>
                                <th class="text-center">Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if referrals %}
                                {% for referral in referrals %}
                                <tr>
                                    <td>{{ referral.name }}</td>
                                    <td>{{ referral.description }}</td>
                                    <td class="text-center">{{ referral.invitations }}</td>
                                    <td class="text-center">{{ referral.reward_sum }} ₽</td>
                                    <td>{{ referral.created_at }}</td>
                                    <td class="text-center">
                                        {% if referral.is_enable %}
                                            <span class="badge badge-success">Активна</span>
                                        {% else %}
                                            <span class="badge badge-danger">Отключена</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        <button type="button" class="btn btn-danger btn-square btn-outline-dashed waves-effect waves-light delete-referral" 
                                                data-id="{{ referral.id }}" data-name="{{ referral.name }}">
                                                <i class="mdi mdi-delete mr-2"></i>Удалить
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="7" class="text-center">
                                        {% if error_message %}
                                            <div class="alert alert-danger">{{ error_message }}</div>
                                        {% else %}
                                            Нет активных реферальных программ или соединение с API не установлено.
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>


<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h4 class="mt-0 header-title">История реферальных вознаграждений</h4>
                        <p class="text-muted">История начисления вознаграждений за приглашение новых пользователей</p>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-bordered mb-0">
                        <thead>
                            <tr>
                                <th>Имя пользователя</th>
                                <th>Telegram ID</th>
                                <th>Реферальная программа</th>
                                <th class="text-center">Вознаграждение</th>
                                <th>Дата</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if rewards_history %}
                                {% for reward in rewards_history %}
                                <tr>
                                    <td>{{ reward.username }}</td>
                                    <td>{{ reward.user_id }}</td>
                                    <td>{{ reward.condition_name }}</td>
                                    <td class="text-center">{{ reward.reward_sum }} ₽</td>
                                    <td>{{ reward.created_at }}</td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="5" class="text-center">
                                        {% if error_message %}
                                            <div class="alert alert-danger">{{ error_message }}</div>
                                        {% else %}
                                            История реферальных вознаграждений пуста или соединение с API не установлено.
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="addReferralModal" tabindex="-1" role="dialog" aria-labelledby="addReferralModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addReferralModalLabel">Добавление реферальной программы</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="referralForm">
                    <div class="form-group">
                        <label for="add_name">Наименование</label>
                        <input type="text" class="form-control" id="add_name" placeholder="Например: Стандартная реферальная программа" required>
                        <small class="form-text text-muted">Укажите название программы для идентификации</small>
                    </div>
                    <div class="form-group">
                        <label for="add_description">Описание</label>
                        <textarea class="form-control" id="add_description" rows="3" placeholder="Подробное описание условий программы"></textarea>
                        <small class="form-text text-muted">Детальное описание для администраторов</small>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="add_invitations">Количество приглашенных</label>
                                <input type="number" class="form-control" id="add_invitations" placeholder="5" min="1" required>
                                <small class="form-text text-muted">Сколько новых клиентов нужно привести</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="add_reward_sum">Сумма вознаграждения (₽)</label>
                                <input type="number" class="form-control" id="add_reward_sum" placeholder="100" min="1" required>
                                <small class="form-text text-muted">Сумма вознаграждения в рублях</small>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" id="saveReferralBtn">Сохранить</button>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="deleteReferralModal" tabindex="-1" role="dialog" aria-labelledby="deleteReferralModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteReferralModalLabel">Подтверждение удаления</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Вы действительно хотите удалить реферальную программу "<span id="delete_referral_name"></span>"?</p>
                <input type="hidden" id="delete_referral_id">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteReferralBtn">Удалить</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        function showNotification(message, type) {
            var icon = 'mdi-check-circle-outline';
            var bgClass = 'bg-success';
            
            if (type === 'error') {
                icon = 'mdi-alert-circle-outline';
                bgClass = 'bg-danger';
            }
            
            var notification = $('<div class="toast fade show" role="alert" aria-live="assertive" aria-atomic="true">' +
                '<div class="toast-header ' + bgClass + ' text-white">' +
                '<i class="mdi ' + icon + ' mr-2"></i>' +
                '<strong class="mr-auto">Уведомление</strong>' +
                '<button type="button" class="ml-2 mb-1 close text-white" data-dismiss="toast" aria-label="Close">' +
                '<span aria-hidden="true">&times;</span>' +
                '</button>' +
                '</div>' +
                '<div class="toast-body">' + message + '</div>' +
                '</div>');
            
            if ($('#toast-container').length === 0) {
                $('body').append('<div id="toast-container" style="position: fixed; top: 20px; right: 20px; z-index: 9999;"></div>');
            }
            
            $('#toast-container').append(notification);
            
            setTimeout(function() {
                notification.toast('hide');
                setTimeout(function() {
                    notification.remove();
                }, 500);
            }, 3000);
        }
        
        $('#addReferralBtn').on('click', function() {
            $('#referralForm')[0].reset();
            $('#addReferralModal').modal('show');
        });
        
        $('#saveReferralBtn').on('click', function() {
            var name = $('#add_name').val();
            var description = $('#add_description').val();
            var invitations = $('#add_invitations').val();
            var reward_sum = $('#add_reward_sum').val();
            
            if (!name) {
                showNotification('Пожалуйста, введите наименование программы', 'error');
                return;
            }
            
            if (!invitations || invitations < 1) {
                showNotification('Пожалуйста, укажите корректное количество приглашенных', 'error');
                return;
            }
            
            if (!reward_sum || reward_sum < 1) {
                showNotification('Пожалуйста, укажите корректную сумму вознаграждения', 'error');
                return;
            }
            
            var referralData = {
                name: name,
                description: description,
                invitations: parseInt(invitations),
                reward_sum: parseInt(reward_sum)
            };
            
            $.ajax({
                url: "{{ url_for('create_referral') }}",
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(referralData),
                success: function(response) {
                    if (response.success) {
                        $('#addReferralModal').modal('hide');
                        
                        showNotification('Реферальная программа успешно создана');
                        
                        setTimeout(function() {
                            location.reload();
                        }, 1000);
                    } else {
                        showNotification('Ошибка: ' + response.message, 'error');
                    }
                },
                error: function(xhr, status, error) {
                    showNotification('Произошла ошибка при создании реферальной программы. Пожалуйста, попробуйте снова.', 'error');
                    console.error(error);
                }
            });
        });
        
        $('.delete-referral').on('click', function() {
            var id = $(this).data('id');
            var name = $(this).data('name');
            
            $('#delete_referral_id').val(id);
            $('#delete_referral_name').text(name);
            
            $('#deleteReferralModal').modal('show');
        });
        
        $('#confirmDeleteReferralBtn').on('click', function() {
            var id = $('#delete_referral_id').val();
            
            $.ajax({
                url: "{{ url_for('delete_referral') }}",
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ id: id }),
                success: function(response) {
                    if (response.success) {
                        $('#deleteReferralModal').modal('hide');
                        
                        showNotification('Реферальная программа успешно удалена');
                        
                        setTimeout(function() {
                            location.reload();
                        }, 1000);
                    } else {
                        showNotification('Ошибка: ' + response.message, 'error');
                    }
                },
                error: function(xhr, status, error) {
                    showNotification('Произошла ошибка при удалении реферальной программы. Пожалуйста, попробуйте снова.', 'error');
                    console.error(error);
                }
            });
        });
    });
</script>
{% endblock %} 