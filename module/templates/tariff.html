{% extends "base.html" %}

{% block title %}Тарифы - Админ Панель{% endblock %}

{% block page_title %}<i class="mdi mdi-tag-multiple mr-2"></i>Управление тарифами{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item active">Тарифы</li>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h4 class="mt-0 header-title">Список доступных тарифов</h4>
                        <p class="text-muted">Тарифы доступные для продажи через Telegram-бот. </p>
                    </div>
                    <div>
                        <button type="button" class="btn btn-primary btn-square btn-outline-dashed waves-effect waves-light" id="addTariffBtn">
                            <i class="mdi mdi-plus mr-2"></i>Добавить тариф
                        </button>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-bordered mb-0">
                        <thead>
                            <tr>
                                <th>Наименование</th>
                                <th>Описание</th>
                                <th class="text-center">Цена</th>
                                <th class="text-center">Дней доступа</th>
                                <th class="text-center">Сервер</th>
                                <th class="text-center">Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if tariffs %}
                                {% for tariff in tariffs %}
                                <tr>
                                    <td>{{ tariff.name }}</td>
                                    <td>{{ tariff.description }}</td>
                                    <td class="text-center">{{ tariff.price }} ₽</td>
                                    <td class="text-center">{{ tariff.left_day }}</td>
                                    <td class="text-center">{{ tariff.server_name }}</td>
                                    <td class="text-center">
                                        <button type="button" class="btn btn-primary btn-square btn-outline-dashed waves-effect waves-light edit-tariff" 
                                               data-id="{{ tariff.id }}"
                                               data-name="{{ tariff.name }}"
                                               data-description="{{ tariff.description }}"
                                               data-price="{{ tariff.price }}"
                                               data-leftday="{{ tariff.left_day }}"
                                               data-servername="{{ tariff.server_name }}">
                                                <i class="mdi mdi-pencil mr-2"></i>Редактировать
                                        </button>
                                        <button type="button" class="btn btn-danger btn-square btn-outline-dashed waves-effect waves-light delete-tariff" 
                                                data-id="{{ tariff.id }}">
                                                <i class="mdi mdi-power mr-2"></i>Удалить
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="6" class="text-center">
                                        {% if error_message %}
                                            <div class="alert alert-danger">{{ error_message }}</div>
                                        {% else %}
                                            Нет доступных тарифов или соединение с API не установлено.
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="addTariffModal" tabindex="-1" role="dialog" aria-labelledby="addTariffModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addTariffModalLabel">Создание нового тарифа</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="addTariffForm">
                    <div class="form-group">
                        <label for="add_name">Наименование</label>
                        <input type="text" class="form-control" id="add_name" required>
                    </div>
                    <div class="form-group">
                        <label for="add_description">Описание</label>
                        <textarea class="form-control" id="add_description" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="add_price">Цена</label>
                        <input type="number" class="form-control" id="add_price" required>
                    </div>
                    <div class="form-group">
                        <label for="add_left_day">Количество дней</label>
                        <input type="number" class="form-control" id="add_left_day" required>
                    </div>
                    <div class="form-group">
                        <label for="add_server_id">Сервер</label>
                        <select class="form-control" id="add_server_id" required>
                            <option value="">Выберите сервер</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-square btn-outline-dashed waves-effect waves-light" data-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary btn-square btn-outline-dashed waves-effect waves-light" id="saveTariffBtn">
                    <i class="mdi mdi-content-save mr-2"></i>Сохранить
                </button>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="editTariffModal" tabindex="-1" role="dialog" aria-labelledby="editTariffModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editTariffModalLabel">Редактирование тарифа</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="editTariffForm">
                    <input type="hidden" id="edit_tariff_id">
                    <div class="form-group">
                        <label for="edit_name">Наименование</label>
                        <input type="text" class="form-control" id="edit_name" required>
                    </div>
                    <div class="form-group">
                        <label for="edit_description">Описание</label>
                        <textarea class="form-control" id="edit_description" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="edit_price">Цена</label>
                        <input type="number" class="form-control" id="edit_price" required>
                    </div>
                    <div class="form-group">
                        <label for="edit_left_day">Количество дней</label>
                        <input type="number" class="form-control" id="edit_left_day" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-square btn-outline-dashed waves-effect waves-light" data-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary btn-square btn-outline-dashed waves-effect waves-light" id="updateTariffBtn">
                    <i class="mdi mdi-content-save mr-2"></i>Сохранить
                </button>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="deleteTariffModal" tabindex="-1" role="dialog" aria-labelledby="deleteTariffModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteTariffModalLabel">Подтверждение удаления</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Вы уверены, что хотите удалить этот тариф?</p>
                <input type="hidden" id="delete_tariff_id">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-square btn-outline-dashed waves-effect waves-light" data-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-danger btn-square btn-outline-dashed waves-effect waves-light" id="confirmDeleteTariffBtn">
                    <i class="mdi mdi-power mr-2"></i>Удалить
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        $('#addTariffBtn').on('click', function() {
            $('#addTariffForm')[0].reset();
            
            $.ajax({
                url: "{{ url_for('get_servers') }}",
                type: 'GET',
                success: function(response) {
                    if (response.success) {
                        $('#add_server_id').find('option').not(':first').remove();
                        
                        $.each(response.servers, function(i, server) {
                            $('#add_server_id').append($('<option>', {
                                value: server.id,
                                text: server.name
                            }));
                        });
                        
                        $('#addTariffModal').modal('show');
                    } else {
                        alert('Ошибка при загрузке серверов: ' + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    alert('Произошла ошибка при загрузке списка серверов.');
                    console.error(error);
                }
            });
        });
        
        $('#saveTariffBtn').on('click', function() {
            if (!$('#add_name').val() || !$('#add_price').val() || !$('#add_left_day').val() || !$('#add_server_id').val()) {
                alert('Пожалуйста, заполните все обязательные поля');
                return;
            }
            
            var tariffData = {
                name: $('#add_name').val(),
                description: $('#add_description').val(),
                price: parseFloat($('#add_price').val()),
                left_day: parseInt($('#add_left_day').val()),
                server_id: parseInt($('#add_server_id').val())
            };
            
            $.ajax({
                url: "{{ url_for('create_tariff') }}",
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(tariffData),
                success: function(response) {
                    if (response.success) {
                        $('#addTariffModal').modal('hide');
                        
                        location.reload();
                    } else {
                        alert('Ошибка: ' + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    alert('Произошла ошибка при создании тарифа. Пожалуйста, попробуйте снова.');
                    console.error(error);
                }
            });
        });
        
        $('.edit-tariff').on('click', function() {
            var id = $(this).data('id');
            var name = $(this).data('name');
            var description = $(this).data('description');
            var price = $(this).data('price');
            var leftDay = $(this).data('leftday');
            
            $('#edit_tariff_id').val(id);
            $('#edit_name').val(name);
            $('#edit_description').val(description);
            $('#edit_price').val(price);
            $('#edit_left_day').val(leftDay);
            
            $('#editTariffModal').modal('show');
        });
        
        $('#updateTariffBtn').on('click', function() {
            if (!$('#edit_name').val() || !$('#edit_price').val() || !$('#edit_left_day').val()) {
                alert('Пожалуйста, заполните все обязательные поля');
                return;
            }
            
            var tariffData = {
                id: $('#edit_tariff_id').val(),
                name: $('#edit_name').val(),
                description: $('#edit_description').val(),
                price: $('#edit_price').val(),
                left_day: $('#edit_left_day').val()
            };
            
            $.ajax({
                url: "{{ url_for('update_tariff') }}",
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(tariffData),
                success: function(response) {
                    if (response.success) {
                        $('#editTariffModal').modal('hide');
                        
                        location.reload();
                    } else {
                        alert('Ошибка: ' + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    alert('Произошла ошибка при обновлении. Пожалуйста, попробуйте снова.');
                    console.error(error);
                }
            });
        });
        
        $('.delete-tariff').on('click', function() {
            var id = $(this).data('id');
            $('#delete_tariff_id').val(id);
            $('#deleteTariffModal').modal('show');
        });
        
        $('#confirmDeleteTariffBtn').on('click', function() {
            var id = $('#delete_tariff_id').val();
            
            $.ajax({
                url: "{{ url_for('delete_tariff') }}",
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ id: id }),
                success: function(response) {
                    if (response.success) {
                        $('#deleteTariffModal').modal('hide');
                        
                        location.reload();
                    } else {
                        alert('Ошибка: ' + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    alert('Произошла ошибка при удалении. Пожалуйста, попробуйте снова.');
                    console.error(error);
                }
            });
        });
    });
</script>
{% endblock %} 